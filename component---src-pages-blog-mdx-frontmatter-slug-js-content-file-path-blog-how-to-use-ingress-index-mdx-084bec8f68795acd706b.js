"use strict";(self.webpackChunkcloudqubes=self.webpackChunkcloudqubes||[]).push([[212],{6595:function(e,n,t){t.r(n),t.d(n,{Head:function(){return m},default:function(){return p}});var a=t(1151),l=t(7294);function r(e){const n=Object.assign({p:"p",a:"a",span:"span",em:"em",h1:"h1",pre:"pre",code:"code",h2:"h2",ul:"ul",li:"li",strong:"strong"},(0,a.ah)(),e.components);return l.createElement(l.Fragment,null,l.createElement("div",{class:"header-highlight"},l.createElement(n.p,null,"Ingress is the preferred way of exposing HTTP applications in Kubernetes. It can manipulate HTTP requests and route traffic to multiple applications inside the cluster.")),"\n",l.createElement(n.p,null,l.createElement(n.a,{href:"https://kubernetes.io/docs/concepts/services-networking/ingress/"},"Kubernetes ingress")," is a mechanism for exposing applications running inside a Kubernetes cluster via HTTP or HTTPS."),"\n",l.createElement(n.p,null,l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 839px; "\n    >\n      <a\n    class="gatsby-resp-image-link"\n    href="/static/ba8e49cf0aac786ed9178a2e0e206f40/d26aa/k8s-ingress-simplified.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n    <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 49.66666666666666%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAA7EAAAOxAGVKw4bAAABVklEQVR42o1Sa2+DMAzs//97k9iX0SEEDMj7AbQrcLND23VdOy3SYZQ457Mvu3mesSzLL1z27+NjzNfzHX8era7rUBQFqqpCWZbQWiOEAO89fPDnGDb4gHEcsBDpQ8J1XeEoSWsDay2EEAlKaSgi1meYvoEXNUTXwDq3KeTLp+OEmXAi7ulzxXFeMTqBwXSkysMYQwU8olOYbIvgTCoWZI3JSzj5kc43QlKki1dCBhOPqNUAYQIWvceq36BFi7Zt0fc9BlkCdg/dlqRYIVqJAxXQSqYRJEJuMQ4Dxmn60baqc/TvL/DUilIKhloPRmAkUm8UpFTwssKBFFrRfCu8zJBbv129kKibNlXmeTkiDiEmA5IhFIPuEBXNT3Zp5k9dZvKBVEdykJ1lhQw2iNvPsgx5nieDNtNkKvjns4kxpiRWw5Evsjkc78H7nH99Ns8e9n9wm8v/XznZBSHmrvCkAAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="Kubernetes ingress - simplified"\n        title=""\n        src="/static/ba8e49cf0aac786ed9178a2e0e206f40/d26aa/k8s-ingress-simplified.png"\n        srcset="/static/ba8e49cf0aac786ed9178a2e0e206f40/5a46d/k8s-ingress-simplified.png 300w,\n/static/ba8e49cf0aac786ed9178a2e0e206f40/0a47e/k8s-ingress-simplified.png 600w,\n/static/ba8e49cf0aac786ed9178a2e0e206f40/d26aa/k8s-ingress-simplified.png 839w"\n        sizes="(max-width: 839px) 100vw, 839px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n  </a>\n    </span>'}}),"\n",l.createElement(n.em,null,"Kubernetes ingress - simplified")),"\n",l.createElement(n.p,null,"This is a simple representation of Kubernetes ingress. To learn how ingress works, you can read up on ",l.createElement(n.a,{href:"../ingress-vs-ingress-controller"},"Kubenetes ingress vs ingress controller"),"."),"\n",l.createElement(n.p,null,l.createElement(n.a,{href:"https://cloudqubes.substack.com/i/106867327/nodeport"},"NodePort")," or ",l.createElement(n.a,{href:"https://cloudqubes.substack.com/i/111987521/loadbalancer-services"},"LoadBalancer")," Services also can expose an application running inside a cluster. But, both ",l.createElement(n.a,{href:"https://cloudqubes.substack.com/i/106867327/nodeport"},"NodePort")," and ",l.createElement(n.a,{href:"https://cloudqubes.substack.com/i/111987521/loadbalancer-services"},"LoadBalancer")," Services work in layer-3 in the OSI model."),"\n",l.createElement(n.p,null,"Ingress works with HTTP protocol in layer-7 so offers more flexibility for HTTP-based applications. Also, ingress does not have some of the limitations in ",l.createElement(n.a,{href:"https://cloudqubes.substack.com/i/106867327/nodeport"},"NodePort")," or ",l.createElement(n.a,{href:"https://cloudqubes.substack.com/i/111987521/loadbalancer-services"},"LoadBalancer")," Services."),"\n",l.createElement(n.p,null,"So, ingress should be your preferred way for exposing HTTP applications inside a Kubernetes cluster to external clients."),"\n",l.createElement(n.p,null,"An ingress defines a set of rules for routing HTTP traffic. You can use these rules to manipulate HTTP requests."),"\n",l.createElement(n.p,null,"Let's check out three such usecases of ingress rules for handling HTTP traffic."),"\n",l.createElement(n.h1,null,"Kubernetes cluster setup"),"\n",l.createElement(n.p,null,"We are using ",l.createElement(n.a,{href:"https://microk8s.io"},"MicroK8s")," from Canonical as our Kubernetes platform for this demonstration."),"\n",l.createElement(n.p,null,l.createElement(n.a,{href:"https://microk8s.io"},"MicroK8s")," includes ",l.createElement(n.a,{href:"https://github.com/kubernetes/ingress-nginx"},"Ingress NGINX Controller")," as an add-on. Since ",l.createElement(n.a,{href:"https://github.com/kubernetes/ingress-nginx"},"Ingress NGINX controller")," is deployed inside the cluster, we need to place a load balancer in front of the ingress controller. So we'll use ",l.createElement(n.a,{href:"https://metallb.universe.tf"},"MetalLB")," load balancer which also comes as an add-on in ",l.createElement(n.a,{href:"https://microk8s.io"},"MicroK8s"),"."),"\n",l.createElement(n.p,null,l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 978px; "\n    >\n      <a\n    class="gatsby-resp-image-link"\n    href="/static/2e6c4731acda16f8ab04929a2d707aa2/914c7/k8s-ingress-microk8s.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n    <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 41.66666666666667%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAA7EAAAOxAGVKw4bAAABRElEQVR42n2S226DMBBE8/9/1vc+Jo0QpebiO2DAgKe7hkRRW9XSCO9KO4yPfdn3HSmlX+L+MAzw3qPveyzLgnVdD8VI3/isY1yf+wsP/rW4L+oaVVXh60vAWgtjDJSSJJ2lNYlqqzqqFaZpOg33jVLtmNeEKVK6RK0YMDiNkVKOTsE7l4dyYiOzjHVwbYWgPmFkgzEEMtw2mPIKTw3ZL2gtGY0BCBKLFTRQAvYK11Vo2g5SdlhNgUXe0TQNevrp5FoYrTDS3IV5eaOwzOE8bMpyskYnSshG4P7+BquPo1pKOugao20ooYWVAqMWMKo9DF8ZplO8pnmG0sSMON2LMhsxM74g3w+0NwcCSwk9cXwk/O9SmJf3LnP0pyGb8LcoCtxuHxmBIjMpJQIz3IghD/8U92dKyeLbe90/an5Kj5oV6Tl9A0LYaWwRFs9CAAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="Microk8s cluster"\n        title=""\n        src="/static/2e6c4731acda16f8ab04929a2d707aa2/914c7/k8s-ingress-microk8s.png"\n        srcset="/static/2e6c4731acda16f8ab04929a2d707aa2/5a46d/k8s-ingress-microk8s.png 300w,\n/static/2e6c4731acda16f8ab04929a2d707aa2/0a47e/k8s-ingress-microk8s.png 600w,\n/static/2e6c4731acda16f8ab04929a2d707aa2/914c7/k8s-ingress-microk8s.png 978w"\n        sizes="(max-width: 978px) 100vw, 978px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n  </a>\n    </span>'}}),"\n",l.createElement(n.em,null,"MicroK8s cluster")),"\n",l.createElement(n.p,null,"Since this MicroK8s cluster is installed in a single virtual machine, our application will be accessible only via localhost (127.0.0.1). But in a production Kubernetes cluster the application will be avialble from one of the public IPs in the load balancer."),"\n",l.createElement(n.p,null,"Let's enable both add-ons in the cluster."),"\n",l.createElement(n.pre,null,l.createElement(n.code,{className:"language-yaml"},"microk8s enable ingress\nmicrok8s enable metallb\n")),"\n",l.createElement(n.p,null,"Check the status of Ingress NGINX Controller."),"\n",l.createElement(n.pre,null,l.createElement(n.code,{className:"language-shell"},"kubectl get pods -n ingress\n")),"\n",l.createElement(n.pre,null,l.createElement(n.code,{className:"language-shell"},"NAME                                      READY   STATUS    RESTARTS   AGE\nnginx-ingress-microk8s-controller-8672t   1/1     Running   0          2m10s\n")),"\n",l.createElement(n.p,null,"Check the status of MetalLB"),"\n",l.createElement(n.pre,null,l.createElement(n.code,{className:"language-shell"},"kubectl get pods -n metallb-system\n")),"\n",l.createElement(n.pre,null,l.createElement(n.code,{className:"language-shell"},"NAME                         READY   STATUS    RESTARTS      AGE\nspeaker-xfbbt                1/1     Running   6 (72d ago)   14m\ncontroller-9556c586f-g9r7w   1/1     Running   3 (72d ago)   14m\n")),"\n",l.createElement(n.p,null,"If all Pods are in ",l.createElement(n.code,null,"Running ")," status, you can proceed to the next step."),"\n",l.createElement(n.h1,null,"The number-crunch application"),"\n",l.createElement(n.p,null,"We will use ",l.createElement(n.a,{href:"https://github.com/cloudqubes/number-crunch"},"number-crunch")," application for this ingress use cases demonstration."),"\n",l.createElement(n.p,null,"The ",l.createElement(n.code,null,"number-crunch")," is a simple HTTP server with two API endpoints that calculate the square root and the cube root of a number."),"\n",l.createElement(n.p,null,l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; "\n    >\n      <a\n    class="gatsby-resp-image-link"\n    href="/static/65a3e17afa0d39b2f3d90a566c69efa8/c5bb3/k8s-ingress-number-crunch-app-only.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n    <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 37.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAA7EAAAOxAGVKw4bAAAAyUlEQVR42qWR2aqFMAxF/f//E30QxBGrCM5ap326Ay3lPl3OCSzSpO1OkwbPfeN9HjwWEwt+zua9WB8H9n0XDrJtuK8LAQ9+Y8uyCOu6Yp5njOOIi4Lv+6Lve2EYBuR5jjRN0TQNuq4TT6qqgtZaLvFVFCvLElEUQZl9ip7niQBGULUtlFJojU+SBHEcI8sy1HWNoijcmsWnaZJC9LwThqEUdIKcB42H/+LPjLFvtk0fadkK/tdssc18Audn/WpG4ATdz/6CEaPWBylqIMKsSlxEAAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="number-crunch application"\n        title=""\n        src="/static/65a3e17afa0d39b2f3d90a566c69efa8/c5bb3/k8s-ingress-number-crunch-app-only.png"\n        srcset="/static/65a3e17afa0d39b2f3d90a566c69efa8/5a46d/k8s-ingress-number-crunch-app-only.png 300w,\n/static/65a3e17afa0d39b2f3d90a566c69efa8/0a47e/k8s-ingress-number-crunch-app-only.png 600w,\n/static/65a3e17afa0d39b2f3d90a566c69efa8/c5bb3/k8s-ingress-number-crunch-app-only.png 680w"\n        sizes="(max-width: 680px) 100vw, 680px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n  </a>\n    </span>'}}),"\n",l.createElement(n.em,null,"number-crunch application")),"\n",l.createElement(n.h2,null,"Creating the Deployment"),"\n",l.createElement(n.p,null,"We will deploy ",l.createElement(n.code,null,"number-crunch")," with two replicas in our MicroK8s cluster."),"\n",l.createElement(n.p,null,l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 901px; "\n    >\n      <a\n    class="gatsby-resp-image-link"\n    href="/static/1a2493452edbf4fc4078f0a185ba764a/0955e/k8s-ingress-number-crunch-1-without-prefix.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n    <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 46.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAA7EAAAOxAGVKw4bAAABe0lEQVR42n1S226DMAzt/3/btqd22kO7lbYEUO4Q7oEzO6XVpE0LsuKg42P72LsYI9ZlwbIZ++u6JpvGEaFt0f5noSGrEUKLkfA7Jvl1lhnEjGma4L2Hdwa1r1HX9f1tDTz5zlo0WqC1ZcL0w0CEVCGfoAoEXREPVdxKoFMEoAopYHVnNKaCdTU6V6W3J7xWCq0p0JHV3mFgwrgRGnGBLW+IccbclIitonZ7+DJDL/ZwUkAqA12cMcojpMiglEZnq5TkSfhoeZoj4uZn2Rla6+Rfrle8vb5QsETTNDh9fmF/OOB2y6llkkLlCFwhtTwMPzXkQfBH7zjPaSgssiWdnPNJO9aQSflfw3qSnY5HfLwfUBRF0vzPoTBZqpoATBBokvc7pMl2XfecMpMbY1LC1PKjEikl8jxPmTiQTz9M6PoefT9gpqo5WAiRcFVVJVmWbc345nnsuEXeN0tZFJEaAnEC/s9rwGTDOIG3gTEFEQoiLCmxd+4u1YOUMN9WELVjXLUkjwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="number-crunch application deployment"\n        title=""\n        src="/static/1a2493452edbf4fc4078f0a185ba764a/0955e/k8s-ingress-number-crunch-1-without-prefix.png"\n        srcset="/static/1a2493452edbf4fc4078f0a185ba764a/5a46d/k8s-ingress-number-crunch-1-without-prefix.png 300w,\n/static/1a2493452edbf4fc4078f0a185ba764a/0a47e/k8s-ingress-number-crunch-1-without-prefix.png 600w,\n/static/1a2493452edbf4fc4078f0a185ba764a/0955e/k8s-ingress-number-crunch-1-without-prefix.png 901w"\n        sizes="(max-width: 901px) 100vw, 901px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n  </a>\n    </span>'}}),"\n",l.createElement(n.em,null,"number-crunch application deployment")),"\n",l.createElement(n.p,null,"Copy and paste this YAML manifest into ",l.createElement(n.code,null,"number-crunch-deployment.yml"),"."),"\n",l.createElement(n.pre,null,l.createElement(n.code,{className:"language-yaml"},"apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: number-crunch-app\nspec:\n  selector:\n    matchLabels:\n      app: number-crunch-app\n  replicas: 2 \n  template:\n    metadata:\n      labels:\n        app: number-crunch-app\n    spec:\n      containers:\n      - name: number-crunch-app\n        image: cloudqubes/number-crunch:1.0.1\n        ports:\n        - containerPort: 8080\n")),"\n",l.createElement(n.p,null,"Create the deployment."),"\n",l.createElement(n.pre,null,l.createElement(n.code,{className:"language-shell"},"kubectl apply -f number-crunch-deployment.yml\n")),"\n",l.createElement(n.p,null,"Check the status of the pods."),"\n",l.createElement(n.pre,null,l.createElement(n.code,{className:"language-shell"},"kubectl get pods\n")),"\n",l.createElement(n.pre,null,l.createElement(n.code,{className:"language-shell"},"NAME                                 READY   STATUS    RESTARTS       AGE     \nnumber-crunch-app-5866dd4d7f-zslzf   1/1     Running   0              3m33s\nnumber-crunch-app-5866dd4d7f-74w9v   1/1     Running   0              3m33s\n")),"\n",l.createElement(n.p,null,"Since both pods are running, let's create the Service,"),"\n",l.createElement(n.h2,null,"Creating the Service"),"\n",l.createElement(n.p,null,"We need a Kubernetes Service to be used as the backend for the ingress."),"\n",l.createElement(n.p,null,"Copy and paste this YMAL manifest into ",l.createElement(n.code,null,"number-crunch-service.yml"),"."),"\n",l.createElement(n.pre,null,l.createElement(n.code,{className:"language-yaml"},"apiVersion: v1\nkind: Service\nmetadata:\n  name: number-crunch-service\nspec:\n  selector:\n    app: number-crunch-app\n  ports:\n  - name: number-crunch-service-port\n    protocol: TCP\n    port: 3001\n    targetPort: 8080\n")),"\n",l.createElement(n.p,null,"Create ",l.createElement(n.code,null,"number-crunch-service"),"."),"\n",l.createElement(n.pre,null,l.createElement(n.code,{className:"language-shell"},"kubectl apply -f number-crunch-service.yml \n")),"\n",l.createElement(n.p,null,"Check the ",l.createElement(n.code,null,"number-crunch-service"),"."),"\n",l.createElement(n.pre,null,l.createElement(n.code,{className:"language-shell"},"kubectl get services\n")),"\n",l.createElement(n.pre,null,l.createElement(n.code,{className:"language-shell"},"NAME                    TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE\nnumber-crunch-service   ClusterIP      10.152.183.17    <none>        3001/TCP         5m10s\n")),"\n",l.createElement(n.h1,null,"Use case #1: Exposing an application via HTTP"),"\n",l.createElement(n.p,null,"As out first use case, we wil simply expose the ",l.createElement(n.code,null,"number-crunch")," API endpoints via ingress."),"\n",l.createElement(n.p,null,"Create ",l.createElement(n.code,null,"ingress.yml")," with this YAML manifest."),"\n",l.createElement(n.pre,null,l.createElement(n.code,{className:"language-yaml"},"apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: number-crunch-ingress\nspec:\n  ingressClassName: nginx\n  rules:\n  - http:\n      paths:\n      - path: /\n        pathType: Prefix\n        backend:\n          service:\n            name: number-crunch-service\n            port:\n              number: 3001\n")),"\n",l.createElement(n.p,null,"Take note of these key parameters in ",l.createElement(n.code,null,"ingress.yml"),"."),"\n",l.createElement(n.ul,null,"\n",l.createElement(n.li,null,"\n",l.createElement(n.p,null,l.createElement(n.strong,null,"ingressClassName")," identifies the Ingress Controller we wish to use."),"\n",l.createElement(n.p,null,"When there are multiple ingress controllers in a cluster, we can choose the desired ingress controller by specifying this parameter."),"\n",l.createElement(n.p,null,"If we omit this parameter, Kubernetes will assign the default ",l.createElement(n.code,null,"IngressClass")," to our ingress. If we specify a non-existing ingress controller, our ingress would still be created, but Kubernetes will not assign an ingress controller for our ingress. So, traffic cannot be routed."),"\n",l.createElement(n.p,null,"If you find the your ingress is not being assigned an address, most probably you may have specified a non-existent ingress controller."),"\n",l.createElement(n.p,null,"You can check the available IngressClasses in your cluster."),"\n",l.createElement(n.pre,null,l.createElement(n.code,{className:"language-shell"},"kubectl get ingressclasses\n")),"\n",l.createElement(n.p,null,"Here's what we got in MicroK8s."),"\n",l.createElement(n.pre,null,l.createElement(n.code,{className:"language-shell"},"NAME     CONTROLLER             PARAMETERS   AGE\npublic   k8s.io/ingress-nginx   <none>       1d\nnginx    k8s.io/ingress-nginx   <none>       1d\n")),"\n"),"\n",l.createElement(n.li,null,"\n",l.createElement(n.p,null,l.createElement(n.strong,null,"rules")," define how to route HTTP traffic to the back-end Kubernetes Services. This ingress has just one rule which sends all traffic to ",l.createElement(n.code,null,"number-crunch")," Service on port 3001."),"\n"),"\n",l.createElement(n.li,null,"\n",l.createElement(n.p,null,l.createElement(n.strong,null,"path")," defines the URL to be matched. ",l.createElement(n.code,null,"/")," denotes the root and matches all HTTP requests."),"\n"),"\n"),"\n",l.createElement(n.p,null,"Create the ingress resource."),"\n",l.createElement(n.pre,null,l.createElement(n.code,{className:"language-shell"},"kubectl apply -f ingress.yml\n")),"\n",l.createElement(n.p,null,"Check the ingress resource."),"\n",l.createElement(n.pre,null,l.createElement(n.code,{className:"language-shell"}," kubectl get ingress\n")),"\n",l.createElement(n.pre,null,l.createElement(n.code,{className:"language-shell"},"NAME                    CLASS    HOSTS   ADDRESS     PORTS   AGE\nnumber-crunch-ingress   public   *       127.0.0.1   80      175m\n")),"\n",l.createElement(n.p,null,"Note the ",l.createElement(n.code,null,"ADDRESS")," and the ",l.createElement(n.code,null,"PORTS")," fields. Our application will be available on http://127.0.0.1/xyz."),"\n",l.createElement(n.p,null,"If the ",l.createElement(n.code,null,"ADDRESS")," field is blank, please check the ingress agian in a few minutes.\nSometimes, Kubernetes may take about one minute to assign the ",l.createElement(n.code,null,"ADDRESS")," to a newly-created ingress resource."),"\n",l.createElement(n.p,null,"Test the ",l.createElement(n.code,null,"number-crunch")," application."),"\n",l.createElement(n.pre,null,l.createElement(n.code,{className:"language-shell"},"curl http://127.0.0.1/square-root/4\n")),"\n",l.createElement(n.pre,null,l.createElement(n.code,{className:"language-shell"},'{"InputNumber":4,"SquareRoot":2}\n')),"\n",l.createElement(n.pre,null,l.createElement(n.code,{className:"language-shell"},"curl http://127.0.0.1/cube-root/8\n")),"\n",l.createElement(n.pre,null,l.createElement(n.code,{className:"language-shell"},'{"InputNumber":4,"CubeRoot":2}\n')),"\n",l.createElement(n.h1,null,"Use case #2: Adding a URL prefix"),"\n",l.createElement(n.p,null,"To avoid URL duplications, we shall add the prefix ",l.createElement(n.code,null,"number-crunch")," to all URLs in the ",l.createElement(n.code,null,"number-crunch")," application."),"\n",l.createElement(n.p,null,l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 907px; "\n    >\n      <a\n    class="gatsby-resp-image-link"\n    href="/static/418e7a4e81748aaff0eeb5f6320ddd0e/142fb/k8s-ingress-number-crunch-1.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n    <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 47%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAA7EAAAOxAGVKw4bAAABeElEQVR42n1Si07DMBDr/3/cQEJim5BYx/pa1jZJ82j6NHdZgSEkIlnXVhefz26yzDPWdcW6LHfwcwQwDgOstbDO3esXtndH1VkNZ3T8No4jkoVI/px5BNYZAzUopaBlg0536DqC1ujoXXcGiqppK3h1hVYSgQQkrJCPERkhx0Jkq6sBgvMBts4AlaJrKrRSw8sK0BnkrUTdNLBNAdeWcdDwSKhEAUVNTDioEpMhwj5AVSnM+RmqrohAoi5O6KsjRJmhrqlHClIoiFBthNvK0zRh2sg/Ps5o2zZ6eblcsNs90WVazxi8n07YHw4oypKsaKNyS6S88i/CnzBWLFs4IYTooSG/NHtHHnLlYVw1+fp23OP4+oKquv4Tyna4gVVZa2LlVH3fIxC895SwhaSBDB72rZDV8EQ2WUoZFTjnKbWRLvLlEC1hz9iCNE2R5zka6n/cipHM5Bs/TKSGFUUvt8oTee0hDODwOMnb7QYhBGqqrBAP/zD3fAJsALYpCOcs9AAAAABJRU5ErkJggg==\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="number-crunch application deployment"\n        title=""\n        src="/static/418e7a4e81748aaff0eeb5f6320ddd0e/142fb/k8s-ingress-number-crunch-1.png"\n        srcset="/static/418e7a4e81748aaff0eeb5f6320ddd0e/5a46d/k8s-ingress-number-crunch-1.png 300w,\n/static/418e7a4e81748aaff0eeb5f6320ddd0e/0a47e/k8s-ingress-number-crunch-1.png 600w,\n/static/418e7a4e81748aaff0eeb5f6320ddd0e/142fb/k8s-ingress-number-crunch-1.png 907w"\n        sizes="(max-width: 907px) 100vw, 907px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n  </a>\n    </span>'}}),"\n",l.createElement(n.em,null,"number-crunch application deployment")),"\n",l.createElement(n.p,null,"Update the ",l.createElement(n.code,null,"ingress.yml")," as below."),"\n",l.createElement(n.pre,null,l.createElement(n.code,{className:"language-yaml"},'apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: number-crunch-ingress\n  annotations:\n    nginx.ingress.kubernetes.io/use-regex: "true"\n    nginx.ingress.kubernetes.io/rewrite-target: /$1\nspec:\n  ingressClassName: nginx\n  rules:\n  - http:\n      paths:\n      - path: /number-crunch/(.*)\n        pathType: Prefix\n        backend:\n          service:\n            name: number-crunch-service\n            port:\n              number: 3001\n')),"\n",l.createElement(n.p,null,"In this manifest, we are using ingress ",l.createElement(n.code,null,"annotations")," to manipulate the URLs using regular expressions."),"\n",l.createElement(n.p,null,"We define the new ",l.createElement(n.code,null,"path")," as ",l.createElement(n.code,null,"/number-crunch/(.*)"),"."),"\n",l.createElement(n.p,null,"The string inside paranthesis is called a Capturing Group in a regular expression. We define one capturing group ",l.createElement(n.code,null,"(.*)")," which captures all characters after ",l.createElement(n.code,null,"/number-crunch/")," in the URL."),"\n",l.createElement(n.p,null,"The characters matching a capturing group is copied to numbered placeholders like $1, $2, $n. Since we have only one capture group, all characters after the ",l.createElement(n.code,null,"/number-crunch/")," in the URL is copied to ",l.createElement(n.code,null,"$1"),"."),"\n",l.createElement(n.p,null,"As an example, if the URL in the HTTP request is ",l.createElement(n.code,null,"number-crunch/square-root/4"),", the characters ",l.createElement(n.code,null,"square-root/4")," will be available in ",l.createElement(n.code,null,"$1"),"."),"\n",l.createElement(n.p,null,"Then, we use ",l.createElement(n.code,null,"$1")," as the ",l.createElement(n.code,null,"rewrite-target"),". This effectively truncates the string ",l.createElement(n.code,null,"number-crunch/")," from the incoming HTTP requests and the traffic to the ",l.createElement(n.code,null,"number-crunch-service"),"."),"\n",l.createElement(n.p,null,"Let's update the ingress resource."),"\n",l.createElement(n.pre,null,l.createElement(n.code,{className:"language-shell"},"kubectl apply -f ingress.yml\n")),"\n",l.createElement(n.p,null,"Test the updated URL endpoints."),"\n",l.createElement(n.pre,null,l.createElement(n.code,{className:"language-shell"},"curl http://127.0.0.1:80/number-crunch/square-root/16\n")),"\n",l.createElement(n.pre,null,l.createElement(n.code,{className:"language-shell"},'{"InputNumber":16,"SquareRoot":4}\n')),"\n",l.createElement(n.p,null,"You may appreciate that we did not have to change anything in our application for this change of the URLs."),"\n",l.createElement(n.h1,null,"Use case #3: number-crunch-2"),"\n",l.createElement(n.p,null,l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 974px; "\n    >\n      <a\n    class="gatsby-resp-image-link"\n    href="/static/818764d89dfc716c8771a97efee89f40/09e48/k8s-ingress-number-crunch-2.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n    <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 57.00000000000001%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAA7EAAAOxAGVKw4bAAABxklEQVR42n2TaY+bQAyG8/9/2+6HbrbtHkoUCJkEmPtKOMJbe+ipdjuSJTOY148PNvM8Y1mWv+x6vSLGiJQScs6wxqA5nSDEGYb8K93l6H6+ZxvHEZv7/Y5/HRaz1sI5V4z9z9tP+PL8BKk0vLogmRZGtdDaQCmF2+32sSBnds7D+4AQAhFqTOaIUVdoux5enjFZgXNT42n7jLquV8KFBFebi9AyRCzzSIIZ3nQIVhYCKSWSFkjqVJ4dCUZ9gdM9tUIUwmEYSJBEwqWCO1eYxhuQW8zZwmiFWe8xyD26rlspidY6Jo4lUVYNgrMlOb8vJYMUcwzIKTIfpDjglgMSNbl62+K0/1qGwATBSETTw1A/raQeur4QKiLWWv/qIU+VD/u9pOYSes4Jh7rBsRElO38w2SNmc0DbdnA0jNE06ESDh8dH7Ha7teT/DYUnzea9J0KNaveC4/6VBNsimG2P6BRVsG7Dh4JMzELut7UJJPpOFK9v7/BEHDzdU9nOmpKQY0rJvNg8blZnn42T8GKX5odUfO6hEAKClvt8WZd7GKci8sOmacKGSTi47/vSJw5ct36moAFXMibmmFP5U0SJZYDv9fxR2TcG60ym7JfB8AAAAABJRU5ErkJggg==\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="number-crunch-2"\n        title=""\n        src="/static/818764d89dfc716c8771a97efee89f40/09e48/k8s-ingress-number-crunch-2.png"\n        srcset="/static/818764d89dfc716c8771a97efee89f40/5a46d/k8s-ingress-number-crunch-2.png 300w,\n/static/818764d89dfc716c8771a97efee89f40/0a47e/k8s-ingress-number-crunch-2.png 600w,\n/static/818764d89dfc716c8771a97efee89f40/09e48/k8s-ingress-number-crunch-2.png 974w"\n        sizes="(max-width: 974px) 100vw, 974px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n  </a>\n    </span>'}}),"\n",l.createElement(n.em,null,"number-crunch-2")),"\n",l.createElement(n.p,null,l.createElement(n.code,null,"number-crunch")," is gaining popularity. We are getting millions of requests everyday."),"\n",l.createElement("span",null,l.createElement(n.p,null,"")),"\n",l.createElement(n.p,null,"We want to make ",l.createElement(n.code,null,"number-crunch")," more scalable. So, we split the ",l.createElement(n.code,null,"square-root")," and ",l.createElement(n.code,null,"cube-root")," API end-points to two different micro-services and create ",l.createElement(n.a,{href:"https://github.com/cloudqubes/number-crunch-2"},"number-crunch-2"),"."),"\n",l.createElement(n.p,null,"We want to upgrade to ",l.createElement(n.code,null,"number-crucnch-2")," without disturbing our clients."),"\n",l.createElement(n.p,null,"We can easily achieve this by manipulating URLs in ingress."),"\n",l.createElement(n.p,null,"Let's deploy the two microservices."),"\n",l.createElement(n.p,null,"Create ",l.createElement(n.code,null,"square-root.yml")," manifest."),"\n",l.createElement(n.pre,null,l.createElement(n.code,{className:"language-yaml"},"apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: square-root-app\nspec:\n  selector:\n    matchLabels:\n      app: square-root-app\n  replicas: 2 \n  template:\n    metadata:\n      labels:\n        app: square-root-app\n    spec:\n      containers:\n      - name: square-root-app\n        image: cloudqubes/square-root:2.0.1\n        ports:\n        - containerPort: 8080\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: square-root-service\nspec:\n  selector:\n    app: square-root-app\n  ports:\n  - name: square-root-service-port\n    protocol: TCP\n    port: 3001\n    targetPort: 8080\n\n")),"\n",l.createElement(n.p,null,"Deploy ",l.createElement(n.code,null,"square-root")," micro-service."),"\n",l.createElement(n.pre,null,l.createElement(n.code,{className:"language-shell"},"kubectl apply -f square-root.yml\n")),"\n",l.createElement(n.p,null,"Create ",l.createElement(n.code,null,"cube-root.yml")," manifest."),"\n",l.createElement(n.pre,null,l.createElement(n.code,{className:"language-yaml"},"apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: cube-root-app\nspec:\n  selector:\n    matchLabels:\n      app: cube-root-app\n  replicas: 2 \n  template:\n    metadata:\n      labels:\n        app: cube-root-app\n    spec:\n      containers:\n      - name: cube-root-app\n        image: cloudqubes/cube-root:2.0.1\n        ports:\n        - containerPort: 8080\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: cube-root-service\nspec:\n  selector:\n    app: cube-root-app\n  ports:\n  - name: cube-root-service-port\n    protocol: TCP\n    port: 3001\n    targetPort: 8080\n")),"\n",l.createElement(n.p,null,"Deploy ",l.createElement(n.code,null,"cube-root")," micro-service."),"\n",l.createElement(n.pre,null,l.createElement(n.code,{className:"language-shell"},"kubectl apply -f cube-root.yml\n")),"\n",l.createElement(n.p,null,"Check the deployments and the Services."),"\n",l.createElement(n.pre,null,l.createElement(n.code,{className:"language-shell"},"kubectl get deployments\n")),"\n",l.createElement(n.pre,null,l.createElement(n.code,{className:"language-shell"},"NAME               READY   UP-TO-DATE   AVAILABLE   AGE\nsquare-root-app    2/2     2            2           10m\ncube-root-app      2/2     2            2           10m\n")),"\n",l.createElement(n.pre,null,l.createElement(n.code,{className:"language-shell"},"kubectl get services\n")),"\n",l.createElement(n.pre,null,l.createElement(n.code,{className:"language-shell"},"NAME                  TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE\nsquare-root-service   ClusterIP      10.152.183.195   <none>        3001/TCP         12m\ncube-root-service     ClusterIP      10.152.183.104   <none>        3001/TCP         12m\n")),"\n",l.createElement(n.p,null,"Update ",l.createElement(n.code,null,"ingress.yml"),"."),"\n",l.createElement(n.pre,null,l.createElement(n.code,{className:"language-yaml"},'apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: number-crunch-2-ingress\n  annotations:\n    nginx.ingress.kubernetes.io/use-regex: "true"\n    nginx.ingress.kubernetes.io/rewrite-target: /$1/$2\nspec:\n  ingressClassName: nginx\n  rules:\n  - http:\n      paths:\n      - path: /number-crunch/(square-root)/(.*)?$\n        pathType: Prefix\n        backend:\n          service:\n            name: square-root-service\n            port:\n              number: 3001\n      - path: /number-crunch/(cube-root)/(.*)?$\n        pathType: Prefix\n        backend:\n          service:\n            name: cube-root-service\n            port:\n              number: 3001\n')),"\n",l.createElement(n.p,null,"We have added two rules - one for each micro-service. The ",l.createElement(n.code,null,"path")," in each rule defines two capturing groups, which copy the matching characters to ",l.createElement(n.code,null,"$1")," and ",l.createElement(n.code,null,"$2")," respectively."),"\n",l.createElement(n.p,null,"In the annotation ",l.createElement(n.code,null,"rewrite-target")," we use ",l.createElement(n.code,null,"/$1/$2")," so effectively removing the ",l.createElement(n.code,null,"number-crunch/")," part in the URL."),"\n",l.createElement(n.p,null,l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 689px; "\n    >\n      <a\n    class="gatsby-resp-image-link"\n    href="/static/bd18e74746a58d843b84a1f8c0a49b64/0f79a/k8s-ingress-capturing-group.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n    <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 36.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAA7EAAAOxAGVKw4bAAABAklEQVR42qWRW2rDMBBFs7VA9hZospssJO53Pkrj4NqVrYcl23rZtxolbimUfrQDF82MhsM8NjFGLMuC1eI8g0LK/ar5/s6pnhghhBxvCGWKAtfDAeXxiKA1etdDDhyTH9FPEsZqyJFjcBqjM9BWwUULPSmE6HMjBCZloD6fE/AJr/s9gpTglqPTTQZw02YoHxgaUUEkMOVayaAmARfcd+BMY/Y9xssFtixpVsQlwkeXxg933zt4ZSDKN0xcQdcMomoyaF3XJ5CC9nRCsd3iebeDZwzSSdy6F6jUTWfewfoaFb8mv0mr6FCLW+rM/gykIzx+8B/7AqYLkXLi4f9F65U/AGQ8HA8TyLNGAAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="Capturing groups for number-crunch-2"\n        title=""\n        src="/static/bd18e74746a58d843b84a1f8c0a49b64/0f79a/k8s-ingress-capturing-group.png"\n        srcset="/static/bd18e74746a58d843b84a1f8c0a49b64/5a46d/k8s-ingress-capturing-group.png 300w,\n/static/bd18e74746a58d843b84a1f8c0a49b64/0a47e/k8s-ingress-capturing-group.png 600w,\n/static/bd18e74746a58d843b84a1f8c0a49b64/0f79a/k8s-ingress-capturing-group.png 689w"\n        sizes="(max-width: 689px) 100vw, 689px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n  </a>\n    </span>'}}),"\n",l.createElement(n.em,null,"Capturing groups for number-crunch-2")),"\n",l.createElement(n.p,null,"Let's update the ingress."),"\n",l.createElement(n.pre,null,l.createElement(n.code,{className:"language-shell"},"kubectl apply -f ingress.yml\n")),"\n",l.createElement(n.p,null,"Test the API end-points with ",l.createElement(n.code,null,"curl"),"."),"\n",l.createElement(n.pre,null,l.createElement(n.code,{className:"language-shell"},"curl http://127.0.0.1:80/number-crunch/square-root/16\n")),"\n",l.createElement(n.pre,null,l.createElement(n.code,{className:"language-shell"},'{"InputNumber":16,"SquareRoot":4}\n')),"\n",l.createElement(n.pre,null,l.createElement(n.code,{className:"language-shell"},"curl http://127.0.0.1:80/number-crunch/cube-root/16\n")),"\n",l.createElement(n.pre,null,l.createElement(n.code,{className:"language-shell"},'{"InputNumber":16,"CubeRoot":2.5198420997897464}\n')),"\n",l.createElement(n.h1,null,"Ingress in production"),"\n",l.createElement(n.p,null,"Ingress is the preferred method for routing external HTTP and HTTPS traffic to applications inside a Kubernetes cluster."),"\n",l.createElement(n.p,null,"We demonstrated three HTTP routing use cases with ",l.createElement(n.a,{href:"https://github.com/kubernetes/ingress-nginx"},"Ingress NGINX Controller")," in a ",l.createElement(n.a,{href:"https://microk8s.io"},"MicroK8s")," cluster."),"\n",l.createElement(n.p,null,"If you are using a different ingress controller, please refer the relevant documentation as the features and functions may vary across different ingress controller implementations."))}var s=function(e){void 0===e&&(e={});const{wrapper:n}=Object.assign({},(0,a.ah)(),e.components);return n?l.createElement(n,e,l.createElement(r,e)):r(e)},c=t(72),i=t(5595),o=t(8370);const u=e=>{let{data:n,children:t}=e;return l.createElement(c.Z,{pageTitle:n.mdx.frontmatter.title},l.createElement("div",{className:o.HV},l.createElement("article",{className:o.nC},l.createElement("div",null,l.createElement("span",{className:o.F4},n.mdx.frontmatter.date," - "),l.createElement("span",{className:o.F4},n.mdx.fields.timeToRead.text)),l.createElement("h1",{className:o.TN},n.mdx.frontmatter.title),t)))},m=e=>{let{data:n}=e;return l.createElement(i.p,{title:n.mdx.frontmatter.title,description:n.mdx.frontmatter.description})};function p(e){return l.createElement(u,e,l.createElement(s,e))}},5595:function(e,n,t){t.d(n,{p:function(){return r}});var a=t(7294),l=t(1883);const r=e=>{let{title:n,description:t,pathname:r,children:s}=e;const{title:c,description:i,image:o,siteUrl:u,twitterUsername:m}=(0,l.useStaticQuery)("1865044719").site.siteMetadata,p={title:n||c,description:t||i,image:""+u+o,url:""+u+(r||""),twitterUsername:m};return a.createElement(a.Fragment,null,a.createElement("title",null,p.title),a.createElement("meta",{name:"description",content:p.description}),a.createElement("meta",{name:"image",content:p.image}),a.createElement("meta",{name:"twitter:card",content:"summary_large_image"}),a.createElement("meta",{name:"twitter:title",content:p.title}),a.createElement("meta",{name:"twitter:url",content:p.url}),a.createElement("meta",{name:"twitter:description",content:p.description}),a.createElement("meta",{name:"twitter:image",content:p.image}),a.createElement("meta",{name:"twitter:creator",content:p.twitterUsername}),a.createElement("link",{rel:"icon",href:"data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>👤</text></svg>"}),s)}},8370:function(e,n,t){t.d(n,{F4:function(){return r},HV:function(){return l},TN:function(){return s},nC:function(){return a}});var a="article-module--container--2d8cc",l="article-module--outerContainer--119e3",r="article-module--post-meta--34964",s="article-module--title--f5d32"},1151:function(e,n,t){t.d(n,{ah:function(){return r}});var a=t(7294);const l=a.createContext({});function r(e){const n=a.useContext(l);return a.useMemo((()=>"function"==typeof e?e(n):{...n,...e}),[n,e])}}}]);
//# sourceMappingURL=component---src-pages-blog-mdx-frontmatter-slug-js-content-file-path-blog-how-to-use-ingress-index-mdx-084bec8f68795acd706b.js.map