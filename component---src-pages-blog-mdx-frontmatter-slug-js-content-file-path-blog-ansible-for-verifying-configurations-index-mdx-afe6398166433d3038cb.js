"use strict";(self.webpackChunkcloudqubes=self.webpackChunkcloudqubes||[]).push([[823],{5396:function(e,n,t){t.r(n),t.d(n,{Head:function(){return m},default:function(){return d}});var l=t(1151),a=t(7294);function s(e){const n=Object.assign({p:"p",code:"code",h1:"h1",pre:"pre",a:"a",h2:"h2",h3:"h3"},(0,l.ah)(),e.components);return a.createElement(a.Fragment,null,a.createElement("div",{class:"header-highlight"},a.createElement(n.p,null,"You are already using Ansible for configuring Linux servers. Here's how to use Ansible for verifing configurations.")),"\n",a.createElement(n.p,null,"Ansible is a handy tool for configuration management."),"\n",a.createElement(n.p,null,"Sometimes, you want to verify configurations without actually changing. You can do that with Ansible ",a.createElement(n.code,null,"assert")," module."),"\n",a.createElement(n.p,null,"The ",a.createElement(n.code,null,"assert")," module can evaluate Jinja2 expressions. Coupled with Ansible variable assignment, you can write Ansible playbooks to check for specific configuration parameters."),"\n",a.createElement(n.h1,null,"How to use Ansible assert"),"\n",a.createElement(n.p,null,"The ",a.createElement(n.code,null,"assert")," module accepts three main parameters."),"\n",a.createElement(n.pre,null,a.createElement(n.code,{className:"language-yaml"},'  - name: task name\n    ansible.builtin.assert:\n      that: \n      - "condition"\n      success_msg: "Success message"\n      fail_msg: "Fail message" \n')),"\n",a.createElement(n.p,null,"The parameter ",a.createElement(n.code,null,"that")," is a list of Jinja2 expressions."),"\n",a.createElement(n.p,null,"The task prints the ",a.createElement(n.code,null,"success_msg")," if all the expressions are evaluated true or ",a.createElement(n.code,null,"fail_msg")," if any expression is false."),"\n",a.createElement(n.p,null,"To build the Jinja2 expressions we can use Ansible variables."),"\n",a.createElement(n.h1,null,"Registering variables"),"\n",a.createElement(n.p,null,"An Ansible task is an invocation of an Ansible module which returns a value. The ",a.createElement(n.code,null,"register")," keyword stores this value in memory and makes it available for subsequent tasks."),"\n",a.createElement(n.pre,null,a.createElement(n.code,{className:"language-yaml"},"- name: list files\n  ansible.builtin.command:\n    cmd: ls -k /home/ubuntu\n  register: cmd_ls\n")),"\n",a.createElement(n.p,null,"The ",a.createElement(n.code,null,"list files")," task invokes the module ",a.createElement(n.code,null,"cmd")," which executes the Linux command ",a.createElement(n.code,null,"ls -k /home/ubuntu"),". The task stores the return value in the variable ",a.createElement(n.code,null,"cmd_ls"),". Any task that comes below this task in the play, can refer the variable ",a.createElement(n.code,null,"cmd_ls"),"."),"\n",a.createElement(n.p,null,"Let's inspect the variable using the ",a.createElement(n.code,null,"debug")," module."),"\n",a.createElement(n.pre,null,a.createElement(n.code,{className:"language-yaml"},"- name: debug cmd_ls\n  ansible.builtin.debug:\n    var: cmd_ls\n")),"\n",a.createElement(n.p,null,"The complete playbook ",a.createElement(n.code,null,"variable-test.yml")," is available in ",a.createElement(n.a,{href:"https://github.com/cloudqubes/ansible_assert"},"ansible_assert")," GitHub repository. Clone the repo and run the playbook to check the output."),"\n",a.createElement(n.pre,null,a.createElement(n.code,{className:"language-shell"},'TASK [debug cmd_ls] ********************************************************************************************************************************************************************************\nok: [740-1-k8s1] => {\n    "cmd_ls": {\n        "changed": true,\n        "cmd": [\n            "ls",\n            "-k",\n            "/home/ubuntu"\n        ],\n        "delta": "0:00:00.005862",\n        "end": "2023-06-10 15:00:20.355971",\n        "failed": false,\n        "msg": "",\n        "rc": 0,\n        "start": "2023-06-10 15:00:20.350109",\n        "stderr": "",\n        "stderr_lines": [],\n        "stdout": "my_file\\ntest_file",\n        "stdout_lines": [\n            "my_file",\n            "test_file"\n        ]\n    }\n}\n')),"\n",a.createElement(n.p,null,"As you can see from this output, the return value of the ",a.createElement(n.code,null,"cmd")," module is a Python dictionary."),"\n",a.createElement(n.p,null,"Most Ansible modules return a similar data structure. You can use the keys and valuse in this data structure for building the Jinja2 expressions for ",a.createElement(n.code,null,"that")," parameter in the ",a.createElement(n.code,null,"assert")," module."),"\n",a.createElement(n.h1,null,"Usecases"),"\n",a.createElement(n.p,null,"Let's see some usecases for verifying configurations with Ansible ",a.createElement(n.code,null,"assert"),"."),"\n",a.createElement(n.h2,null,"Check the existence of a file"),"\n",a.createElement(n.p,null,"The module ",a.createElement(n.code,null,"stat")," can retrieve status of files and directories."),"\n",a.createElement(n.p,null,"This task retrieves the status of ",a.createElement(n.code,null,"test_file")," in the user's home directory."),"\n",a.createElement(n.pre,null,a.createElement(n.code,{className:"language-yaml"},"- name: Get status of test_file\n  ansible.builtin.stat:\n    path: /home/ubuntu/test_file\n  register: test_file_1\n")),"\n",a.createElement(n.p,null,"Inspect the contents of the ",a.createElement(n.code,null,"test_file_1")," variable with debug."),"\n",a.createElement(n.pre,null,a.createElement(n.code,{className:"language-yaml"},"  - name: debug test_file_1\n    ansible.builtin.debug:\n      var: test_file_1\n")),"\n",a.createElement(n.p,null,"Task output."),"\n",a.createElement(n.pre,null,a.createElement(n.code,{className:"language-shell"},'TASK [debug test_file_1] ***************************************************************************************************************************************************************************\nok: [740-1-k8s1] => {\n    "test_file_1": {\n        "changed": false,\n        "failed": false,\n        "stat": {\n            "atime": 1686121585.736978,\n            "attr_flags": "e",\n            "attributes": [\n                "extents"\n            ],\n            "block_size": 4096,\n            "blocks": 8,\n            "charset": "us-ascii",\n            "checksum": "6f2170a833122bdfb8382742c2ca693a36c3ac58",\n            "ctime": 1685828081.3049781,\n            "dev": 2049,\n            "device_type": 0,\n            "executable": false,\n            "exists": true,\n            "gid": 1000,\n            "gr_name": "ubuntu",\n            "inode": 258118,\n            "isblk": false,\n            "ischr": false,\n            "isdir": false,\n            "isfifo": false,\n            "isgid": false,\n            "islnk": false,\n            "isreg": true,\n            "issock": false,\n            "isuid": false,\n            "mimetype": "text/plain",\n            "mode": "0664",\n            "mtime": 1685828081.3049781,\n            "nlink": 1,\n            "path": "/home/ubuntu/test_file",\n            "pw_name": "ubuntu",\n            "readable": true,\n            "rgrp": true,\n            "roth": true,\n            "rusr": true,\n            "size": 45,\n            "uid": 1000,\n            "version": "1457468022",\n            "wgrp": true,\n            "woth": false,\n            "writeable": true,\n            "wusr": true,\n            "xgrp": false,\n            "xoth": false,\n            "xusr": false\n        }\n    }\n}\n')),"\n",a.createElement(n.p,null,"The ",a.createElement(n.code,null,"stat")," module returns a range of key-value pairs that represent multiple parameters about the file. Some keys are self explanatory. Refer the ",a.createElement(n.a,{href:"https://docs.ansible.com/ansible/latest/collections/ansible/builtin/stat_module.html"},"Stat module docs")," for interpretation of the others."),"\n",a.createElement(n.p,null,"Here are three usefule keys and how to use them in Jinja2 expressions in ",a.createElement(n.code,null,"assert")," module."),"\n",a.createElement(n.p,null,"The ",a.createElement(n.code,null,"exists")," key is a boolean representation of the existence of the file."),"\n",a.createElement(n.pre,null,a.createElement(n.code,{className:"language-yaml"},'- name: assert test_file exists\n  ansible.builtin.assert:\n    that: \n    - "test_file.stat.exists"\n    success_msg: "OK: test_file exists"\n    fail_msg: "NOK: test_file does not exists"\n')),"\n",a.createElement(n.p,null,"The ",a.createElement(n.code,null,"pw_name")," key holds the username of the owner. We will check whether the value equals ",a.createElement(n.code,null,"ubuntu"),"."),"\n",a.createElement(n.pre,null,a.createElement(n.code,{className:"language-yaml"},'  - name: assert test_file owner username is ubuntu\n    ansible.builtin.assert:\n      that: \n      - "test_file.stat.pw_name == \'ubuntu\'"\n      success_msg: "OK: test_file owner is ubuntu"\n      fail_msg: "NOK: test_file owner is not ubuntu"\n')),"\n",a.createElement(n.p,null,"The ",a.createElement(n.code,null,"gr_name")," key holds the group name of owner and here's how we check whether the owner does not belong to the ",a.createElement(n.code,null,"root")," user group."),"\n",a.createElement(n.pre,null,a.createElement(n.code,{className:"language-yaml"},'  - name: assert test_file owner group name is not root\n    ansible.builtin.assert:\n      that: \n      - "test_file.stat.gr_name != \'root\'"\n      success_msg: "OK: test_file owner group is not root"\n      fail_msg: "NOK: test_file owner group is root"\n')),"\n",a.createElement(n.p,null,"Create the file ",a.createElement(n.code,null,"/home/ubuntu/test_file")," and run the playbook ",a.createElement(n.code,null,"file-check.yml")," in the ",a.createElement(n.a,{href:"https://github.com/cloudqubes/ansible_assert"},"ansible_assert")," to see the output."),"\n",a.createElement(n.h2,null,"Check the contents of a file"),"\n",a.createElement(n.p,null,"The Ansible module ",a.createElement(n.code,null,"command")," can run Linux commands.\nLet's run ",a.createElement(n.code,null,"cat")," command with the ",a.createElement(n.code,null,"test_file")," and inpect the contents."),"\n",a.createElement(n.pre,null,a.createElement(n.code,{className:"language-yaml"},"  - name: cat test_file\n    ansible.builtin.command:\n      cmd: cat /home/ubuntu/test_file\n    register: test_file\n")),"\n",a.createElement(n.p,null,"Here's the debug output of the `test_file."),"\n",a.createElement(n.pre,null,a.createElement(n.code,{className:"language-yaml"},'TASK [debug test_file] *****************************************************************************************************************************************************************************\nok: [740-1-k8s1] => {\n    "test_file": {\n        "changed": true,\n        "cmd": [\n            "cat",\n            "/home/ubuntu/test_file"\n        ],\n        "delta": "0:00:00.005361",\n        "end": "2023-06-07 07:32:53.087623",\n        "failed": false,\n        "msg": "",\n        "rc": 0,\n        "start": "2023-06-07 07:32:53.082262",\n        "stderr": "",\n        "stderr_lines": [],\n        "stdout": "test_string\\nnew string\\nThis string is in fil",\n        "stdout_lines": [\n            "test_string",\n            "new string",\n            "This string is in fil"\n        ]\n    }\n}\n\n')),"\n",a.createElement(n.p,null,"The ",a.createElement(n.code,null,"test_file.stdout")," contains the output of the ",a.createElement(n.code,null,"cat")," command.\nWe can use it in Jinja2 expressions to check the contents of the file."),"\n",a.createElement(n.pre,null,a.createElement(n.code,{className:"language-yaml"},'  - name: assert line in file\n    ansible.builtin.assert:\n      that: \n      - "\'This string is in file\' in test_file.stdout"\n      success_msg: "OK: String is in file"\n      fail_msg: "NOK: String is not in file"\n\n  - name: assert line not in file\n    ansible.builtin.assert:\n      that: \n      - "\'This string is not in file\' not in test_file.stdout"\n      success_msg: "OK: String is not in file"\n      fail_msg: "NOK: String is in file\n')),"\n",a.createElement(n.p,null,"Refer ",a.createElement(n.code,null,"file-content-check.yml")," in the ",a.createElement(n.a,{href:"https://github.com/cloudqubes/ansible_assert"},"ansible_assert")," for the complete playbook."),"\n",a.createElement(n.h2,null,"Check the status of a service"),"\n",a.createElement(n.p,null,"The module ",a.createElement(n.code,null,"ansible.builtin.service_facts")," can rerieve information related to services and store them in ",a.createElement(n.code,null,"ansible_facts.services")," variable."),"\n",a.createElement(n.pre,null,a.createElement(n.code,{className:"language-yaml"},"  - name: Populate service facts\n    ansible.builtin.service_facts:\n")),"\n",a.createElement(n.p,null,"Let's print the ",a.createElement(n.code,null,"ansible_facts.services")," to see what it contains."),"\n",a.createElement(n.pre,null,a.createElement(n.code,{className:"language-yaml"},"- name: Print service facts\n  ansible.builtin.debug:\n    var: ansible_facts.services\n")),"\n",a.createElement(n.p,null,"We get a list of the services installed in the target system."),"\n",a.createElement(n.p,null,"Note that a part of the output is omitted for brevity."),"\n",a.createElement(n.pre,null,a.createElement(n.code,{className:"language-shell"},'TASK [Print service facts] *************************************************************************************************************************************************************************\nok: [740-1-k8s1] => {\n    "ansible_facts.services": {\n        "ModemManager.service": {\n            "name": "ModemManager.service",\n            "source": "systemd",\n            "state": "running",\n            "status": "enabled"\n        },\n        "NetworkManager.service": {\n            "name": "NetworkManager.service",\n            "source": "systemd",\n            "state": "stopped",\n            "status": "not-found"\n        },\n        "accounts-daemon.service": {\n            "name": "accounts-daemon.service",\n            "source": "systemd",\n            "state": "running",\n            "status": "enabled"\n        },\n        "apparmor": {\n            "name": "apparmor",\n            "source": "sysv",\n            "state": "running"\n        },\n...\n')),"\n",a.createElement(n.p,null,"Check whether ",a.createElement(n.code,null,"apparmor")," service is running."),"\n",a.createElement(n.pre,null,a.createElement(n.code,{className:"language-yaml"},'  - name: assert apparmor is running\n    ansible.builtin.assert:\n      that: \n      - "ansible_facts.services.apparmor.state == \'running\'"\n      success_msg: "OK: apparmor is running"\n      fail_msg: "NOK: apparmor is not running"\n')),"\n",a.createElement(n.p,null,"Some service names hava a dot notation such as ",a.createElement(n.code,null,"ssh.service"),".\nFor accessing such keys use the Python array notations - single quoted key within square brackets."),"\n",a.createElement(n.pre,null,a.createElement(n.code,{className:"language-yaml"},'  - name: assert ssh.service is running\n    ansible.builtin.assert:\n      that: \n      - "ansible_facts.services[\'ssh.service\'].state == \'running\'"\n      success_msg: "OK: ssh.service is running"\n      fail_msg: "NOK: ssh.service is not running"\n')),"\n",a.createElement(n.p,null,"Run the playbook ",a.createElement(n.code,null,"service-check.yml")," in the ",a.createElement(n.a,{href:"https://github.com/cloudqubes/ansible_assert"},"ansible_assert")," to see the output."),"\n",a.createElement(n.h3,null,"Check the status of a kernel module"),"\n",a.createElement(n.p,null,"Ansible does not have a module for checking status of Linux kernel modules. But, we can use the ",a.createElement(n.code,null,"command")," module to get output of ",a.createElement(n.code,null,"lsmod")," and analyze."),"\n",a.createElement(n.pre,null,a.createElement(n.code,{className:"language-yaml"},'  - name: List loaded kernel modules\n    ansible.builtin.command:\n      cmd: "lsmod"\n    register: loaded_modules\n')),"\n",a.createElement(n.p,null,"Checking the ",a.createElement(n.code,null,"ip_tables")," module status."),"\n",a.createElement(n.pre,null,a.createElement(n.code,{className:"language-yaml"},'  - name: Check iptables is loaded\n    ansible.builtin.assert:\n      that:\n      - "\'ip_tables\' in loaded_modules.stdout" \n      success_msg: "OK: ip_tables is loaded"\n      fail_msg: "NOK: ip_tables is not loaded"\n')),"\n",a.createElement(n.p,null,"The ",a.createElement(n.code,null,"command")," module does not use the Linux shell to execute commands. So, it cannot interpret ",a.createElement(n.code,null,"$")," notations.\nTo run commands with such notations, use the ",a.createElement(n.code,null,"shell")," module."),"\n",a.createElement(n.pre,null,a.createElement(n.code,{className:"language-yaml"},"  - name: List all kernel modules\n    ansible.builtin.shell:\n      cmd: \"find /lib/modules/$(uname -r) -name '*.ko*'\"\n    register: all_modules\n")),"\n",a.createElement(n.p,null,"Run the playbook ",a.createElement(n.code,null,"kernel-module-check.yml")," in the ",a.createElement(n.a,{href:"https://github.com/cloudqubes/ansible_assert"},"ansible_assert")," to see the output."),"\n",a.createElement(n.h3,null,"Ignoring errors"),"\n",a.createElement(n.p,null,"Ansible stops execution when a task fails. That's fine for configuring servers."),"\n",a.createElement(n.p,null,"But, when we are using Ansible for verifying configurations, we need to continue even if a task evaluates to false.\nSo, when using Ansible for configuration verification set ",a.createElement(n.code,null,"ignore errors")," to true in the playbook."),"\n",a.createElement(n.pre,null,a.createElement(n.code,{className:"language-yaml"},"  ignore_errors: true\n")),"\n",a.createElement(n.h3,null,"Ansible can do many things"),"\n",a.createElement(n.p,null,"Ansible can do things other than configuring servers. We just used Ansible for verifying configurations. These configuration verification capabilities in Ansible are handy for automating security compliance checking and audits."),"\n",a.createElement(n.p,null,"In future posts, let's explore more usecases of Ansible."))}var r=function(e){void 0===e&&(e={});const{wrapper:n}=Object.assign({},(0,l.ah)(),e.components);return n?a.createElement(n,e,a.createElement(s,e)):s(e)},i=t(72),c=t(5595),o=t(8370);const u=e=>{let{data:n,children:t}=e;return a.createElement(i.Z,{pageTitle:n.mdx.frontmatter.title},a.createElement("div",{className:o.HV},a.createElement("article",{className:o.nC},a.createElement("div",null,a.createElement("span",{className:o.F4},n.mdx.frontmatter.date," - "),a.createElement("span",{className:o.F4},n.mdx.fields.timeToRead.text)),a.createElement("h1",{className:o.TN},n.mdx.frontmatter.title),t)))},m=e=>{let{data:n}=e;return a.createElement(c.p,{title:n.mdx.frontmatter.title,description:n.mdx.frontmatter.description})};function d(e){return a.createElement(u,e,a.createElement(r,e))}},5595:function(e,n,t){t.d(n,{p:function(){return s}});var l=t(7294),a=t(1883);const s=e=>{let{title:n,description:t,pathname:s,children:r}=e;const{title:i,description:c,image:o,siteUrl:u,twitterUsername:m}=(0,a.useStaticQuery)("1865044719").site.siteMetadata,d={title:n||i,description:t||c,image:""+u+o,url:""+u+(s||""),twitterUsername:m};return l.createElement(l.Fragment,null,l.createElement("title",null,d.title),l.createElement("meta",{name:"description",content:d.description}),l.createElement("meta",{name:"image",content:d.image}),l.createElement("meta",{name:"twitter:card",content:"summary_large_image"}),l.createElement("meta",{name:"twitter:title",content:d.title}),l.createElement("meta",{name:"twitter:url",content:d.url}),l.createElement("meta",{name:"twitter:description",content:d.description}),l.createElement("meta",{name:"twitter:image",content:d.image}),l.createElement("meta",{name:"twitter:creator",content:d.twitterUsername}),l.createElement("link",{rel:"icon",href:"data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>👤</text></svg>"}),r)}},8370:function(e,n,t){t.d(n,{F4:function(){return s},HV:function(){return a},TN:function(){return r},nC:function(){return l}});var l="article-module--container--2d8cc",a="article-module--outerContainer--119e3",s="article-module--post-meta--34964",r="article-module--title--f5d32"},1151:function(e,n,t){t.d(n,{ah:function(){return s}});var l=t(7294);const a=l.createContext({});function s(e){const n=l.useContext(a);return l.useMemo((()=>"function"==typeof e?e(n):{...n,...e}),[n,e])}}}]);
//# sourceMappingURL=component---src-pages-blog-mdx-frontmatter-slug-js-content-file-path-blog-ansible-for-verifying-configurations-index-mdx-afe6398166433d3038cb.js.map