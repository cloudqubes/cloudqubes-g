"use strict";(self.webpackChunkcloudqubes=self.webpackChunkcloudqubes||[]).push([[40],{2361:function(e,t,n){n.r(t),n.d(t,{Head:function(){return m},default:function(){return d}});var a=n(1151),r=n(7294);function l(e){const t=Object.assign({p:"p",a:"a",h2:"h2",ul:"ul",li:"li",h1:"h1",span:"span",em:"em",ol:"ol",pre:"pre",code:"code",strong:"strong"},(0,a.ah)(),e.components);return r.createElement(r.Fragment,null,r.createElement("div",{class:"header-highlight"},r.createElement(t.p,null,"A private container registry stores your container images within the premises of your data center. It's secure and quick even for 10GB+ images.")),"\n",r.createElement(t.p,null,r.createElement(t.a,{href:"https://goharbor.io/"},"Harbor")," is an open-source registry for cloud-native platforms."),"\n",r.createElement(t.p,null,"You can set up a fully-fledged private container registry with ",r.createElement(t.a,{href:"https://goharbor.io/"},"Harbor"),"."),"\n",r.createElement(t.p,null,"A container registry is an essential part of your CI/CD pipeline."),"\n",r.createElement(t.p,null,"When deploying a Workload, the Kubernetes control plane schedules Pods into nodes in the cluster. Then, each node pulls the required container images from a container registry as specified by the Workload manifest."),"\n",r.createElement(t.p,null,r.createElement(t.a,{href:"https://hub.docker.com/"},"DockerHub")," is a well-known container registry available as a service via the Internet. While a container registry as-a-service is convenient, there are certain use cases for a private container registry."),"\n",r.createElement(t.h2,null,"Why use a private container registry"),"\n",r.createElement(t.ul,null,"\n",r.createElement(t.li,null,"\n",r.createElement(t.p,null,"Security policies in some organizations mandate that container images must be stored within the boundaries of the organization."),"\n"),"\n",r.createElement(t.li,null,"\n",r.createElement(t.p,null,"Pulling large container images (10GB+) from the Internet could be time-consuming and inefficient."),"\n"),"\n",r.createElement(t.li,null,"\n",r.createElement(t.p,null,"Allowing a production Kubernetes cluster to access a container registry on the Internet is a security threat."),"\n"),"\n"),"\n",r.createElement(t.p,null,"A private container registry inside your data center is the best solution for these problems."),"\n",r.createElement(t.h2,null,"Networking requirements for a private container registry"),"\n",r.createElement(t.p,null,"You can deploy a private container registry with Harbor in either an on-premise data center or a VPC in a public cloud."),"\n",r.createElement(t.p,null,"To pull the container images, Harbor must be accessible via HTTPS to all nodes in your Kubernetes clusters. You may have to configure routing and firewall rules in your data center to allow access to Harbor from the nodes."),"\n",r.createElement(t.p,null,"If a particular node cannot access Harbor, the Pods scheduled in that node will fail to start."),"\n",r.createElement(t.h1,null,"What we are going to build"),"\n",r.createElement(t.p,null,"We are going to install Harbor on an Ubuntu 18.04 host. Then, we will build the ",r.createElement(t.a,{href:"https://github.com/cloudqubes/number-crunch"},"number-crunch")," application on the development workstation, push the images to Harbor, and create a Kubernetes Deployment."),"\n",r.createElement(t.p,null,r.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1105px; "\n    >\n      <a\n    class="gatsby-resp-image-link"\n    href="/static/ba77bdab54c4352ade58f7c61d4515c3/23725/harbor-setup.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n    <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 45.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAA7EAAAOxAGVKw4bAAABf0lEQVR42nWSwU7jMBCGeWGeAHHjPfbAlSNHOO1lV1rgQClILCxb2qSO49RJHNuxHf+MUyK1oow09oxlf/PPyEfDMCDGCNV1sNaOcfLJnPNYlRVWrMRiXaDVZjxP76a3k6f8aEoEyyCrcoyNMdBaI9IFN0S0qsXT84x2DeMI4gOwU3SyTyAFwSN/+I3idQ4fBkgpwYoCPSnWLuBnrvDjzy2uco2MK5gFg+E1vLZbUtwDbrN/L3+xzjN476lNN7aaFJoQcfZocDrrcHynMJd+JHgqFKn4F4VpmZIEb9sWvCzBGB/b3ioYEJxFsNQyzdqHgEO2B5wszc+7niCO1G6V1qqDI+VlJfG+XEEIAWN79NRJ2IEfBFrT4Wb2HxfXb1hmBbhssBI1yk2N9aYBbxQK2jMhsSbXuvsemMYZg8HlL4mT8xqz1xrVpkL2zghSI884WM4JVoMtGXIm0B0C7v4l11sUosX9S4NOKVSkkHGJpiVlSSm5JJXpTJBSSyPa/YcfBxm25koYy/IAAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="Harbor registry and K8s cluster"\n        title=""\n        src="/static/ba77bdab54c4352ade58f7c61d4515c3/23725/harbor-setup.png"\n        srcset="/static/ba77bdab54c4352ade58f7c61d4515c3/5a46d/harbor-setup.png 300w,\n/static/ba77bdab54c4352ade58f7c61d4515c3/0a47e/harbor-setup.png 600w,\n/static/ba77bdab54c4352ade58f7c61d4515c3/23725/harbor-setup.png 1105w"\n        sizes="(max-width: 1105px) 100vw, 1105px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n  </a>\n    </span>'}}),"\n",r.createElement(t.em,null,"Harbor registry and K8s cluster")),"\n",r.createElement(t.p,null,"Harbor is a containerized application and can be installed either on Docker or Kubernetes. Let's use Docker for this setup."),"\n",r.createElement(t.p,null,"To keep things simple we will not implement high availability here. But, you must definitely consider high availability in a production setup."),"\n",r.createElement(t.p,null,"Here are the steps we have to go through."),"\n",r.createElement(t.ol,null,"\n",r.createElement(t.li,null,"Prerequisites"),"\n",r.createElement(t.li,null,"Create SSL certificates"),"\n",r.createElement(t.li,null,"Install Harbor"),"\n",r.createElement(t.li,null,"Create a project in Harbor"),"\n",r.createElement(t.li,null,"Push images to Harbor"),"\n",r.createElement(t.li,null,"Create Kubernetes Deployment"),"\n"),"\n",r.createElement(t.p,null,"Let's get started."),"\n",r.createElement(t.h1,null,"#1 Prerequisites"),"\n",r.createElement(t.h2,null,"Set up networking"),"\n",r.createElement(t.p,null,"Make sure all nodes in your Kubernetes cluster can reach the Harbor host via HTTPS by configuring routing and firewall rules."),"\n",r.createElement(t.h2,null,"Install Docker"),"\n",r.createElement(t.p,null,"Install Docker and Docker Compose on Harbor host."),"\n",r.createElement(t.pre,null,r.createElement(t.code,{className:"language-shell"},"sudo apt update\nsudo apt install docker\nsudo apt install docker-compose\n")),"\n",r.createElement(t.p,null,"Install ",r.createElement(t.a,{href:"https://www.docker.com/products/docker-desktop/"},"Docker Desktop")," on the Developer Workstation for building container images."),"\n",r.createElement(t.h2,null,"Configure DNS"),"\n",r.createElement(t.p,null,"We use ",r.createElement(t.code,null,"registry.cloudqubes.com")," as the FQDN of Harbor. The developer workstation as well as the Kubernetes nodes must resolve this FQDN to the IP address of the Harbor host."),"\n",r.createElement(t.p,null,"So, configure ",r.createElement(t.code,null,"registry.cloudqubes.com")," in your local DNS server."),"\n",r.createElement(t.p,null,"If you do not have a local DNS server, you can configure the ",r.createElement(t.code,null,"hosts")," file in the developer workstation and in each node of the cluster to resolve ",r.createElement(t.code,null,"registry.cloudqubes.com")," to the Harbor host IP address."),"\n",r.createElement(t.h1,null,"#2 Create SSL certificates"),"\n",r.createElement(t.p,null,"We need an SSL certificate to enable HTTPS access to Harbor."),"\n",r.createElement(t.p,null,"We can either get a signed certificate from a CA or create a self-signed certificate. Let's use a self-signed certificate for this setup."),"\n",r.createElement(t.p,null,"We'll use ",r.createElement(t.code,null,"registry.cloudqubes.com")," as the FQDN of our Harbor host."),"\n",r.createElement(t.p,null,"You can create these certificates on any Linux host."),"\n",r.createElement(t.p,null,"Create the private key for the CA certificate."),"\n",r.createElement(t.pre,null,r.createElement(t.code,{className:"language-shell"},"openssl genrsa -out ca.key 4096\n")),"\n",r.createElement(t.p,null,"Create the CA certificate - valid for 10 years.\nIf you continue to use this in production, make sure to renew it in 10 years from today."),"\n",r.createElement(t.pre,null,r.createElement(t.code,{className:"language-shell"},'openssl req -x509 -new -nodes -sha512 -days 3650 \\\n -subj "/C=US/ST=Delaware/L=Lewes/O=CloudQubes/OU=IT/CN=registry.cloudqubes.com" \\\n -key ca.key \\\n -out ca.crt\n')),"\n",r.createElement(t.p,null,"Create private key."),"\n",r.createElement(t.pre,null,r.createElement(t.code,{className:"language-shell"},"openssl genrsa -out registry.cloudqubes.com.key 4096\n")),"\n",r.createElement(t.p,null,"Create certificate signing request."),"\n",r.createElement(t.pre,null,r.createElement(t.code,{className:"language-shell"},'openssl req -sha512 -new \\\n    -subj "/C=CN/ST=Beijing/L=Beijing/O=example/OU=Personal/CN=registry.cloudqubes.com" \\\n    -key registry.cloudqubes.com.key \\\n    -out registry.cloudqubes.com.csr\n')),"\n",r.createElement(t.p,null,"Create X509 v3 extension file."),"\n",r.createElement(t.pre,null,r.createElement(t.code,{className:"language-shell"},"cat > v3.ext <<-EOF\nauthorityKeyIdentifier=keyid,issuer\nbasicConstraints=CA:FALSE\nkeyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment\nextendedKeyUsage = serverAuth\nsubjectAltName = @alt_names\n\n[alt_names]\nDNS.1=registry.cloudqubes.com\nDNS.2=cloudqubes.com\nDNS.3=registry\nEOF\n")),"\n",r.createElement(t.p,null,"Create certificate for Harbor host."),"\n",r.createElement(t.pre,null,r.createElement(t.code,{className:"language-shell"},"openssl x509 -req -sha512 -days 3650 \\\n    -extfile v3.ext \\\n    -CA ca.crt -CAkey ca.key -CAcreateserial \\\n    -in registry.cloudqubes.com.csr \\\n    -out registry.cloudqubes.com.crt\n")),"\n",r.createElement(t.h2,null,"Copy the certificates to Harbor host"),"\n",r.createElement(t.p,null,"Copy the server certificate and key to the certificate folder in Harbor host."),"\n",r.createElement(t.pre,null,r.createElement(t.code,{className:"language-shell"},"sudo cp registry.cloudqubes.com.crt /data/cert/\nsudo cp registry.cloudqubes.com.key /data/cert/\n")),"\n",r.createElement(t.p,null,"Convert ",r.createElement(t.code,null,"registry.cloudqubes.com.crt")," to ",r.createElement(t.code,null,".cert")," file."),"\n",r.createElement(t.pre,null,r.createElement(t.code,{className:"language-shell"},"openssl x509 -inform PEM -in registry.cloudqubes.com.crt -out registry.cloudqubes.com.cert\n")),"\n",r.createElement(t.p,null,"Copy the certificate file to Docker certificates folder."),"\n",r.createElement(t.pre,null,r.createElement(t.code,{className:"language-shell"},"cp registry.cloudqubes.com.cert /etc/docker/certs.d/registry.cloudqubes.com/\ncp registry.cloudqubes.com.key /etc/docker/certs.d/registry.cloudqubes.com/\ncp ca.crt /etc/docker/certs.d/registry.cloudqubes.com/\n")),"\n",r.createElement(t.p,null,"Restart Docker."),"\n",r.createElement(t.pre,null,r.createElement(t.code,{className:"language-shell"},"sudo systemctl restart docker\n")),"\n",r.createElement(t.h2,null,"Copy the CA certificate to all Kubernetes nodes"),"\n",r.createElement(t.p,null,"Since we are using a self-signed certificate in Harbor we need to ",r.createElement(t.em,null,"tell")," each node in the Kubernetes cluster to trust it.\nCopy the CA certificate ",r.createElement(t.code,null,"ca.crt")," from the Harbor host to all nodes in the Kubernetes cluster."),"\n",r.createElement(t.p,null,"Login to each node and run the following commands."),"\n",r.createElement(t.pre,null,r.createElement(t.code,{className:"language-shell"},"sudo cp ca.crt /usr/local/share/ca-certificates\nsudo update-ca-certificates\nsudo systemctl restart containerd.service\n")),"\n",r.createElement(t.p,null,"Remember to do the same for any new nodes you add to the cluster. If not, the Pods scheduled on the particular nodes will fail."),"\n",r.createElement(t.h1,null,"#3 Install Harbor"),"\n",r.createElement(t.p,null,"Harbor has two installation methods."),"\n",r.createElement(t.ul,null,"\n",r.createElement(t.li,null,"\n",r.createElement(t.p,null,r.createElement(t.strong,null,"Online installer")," downloads the Harbor container images from ",r.createElement(t.a,{href:"https://hub.docker.com/"},"DockerHub")," during the installation. The Harbor host must have Internet access for this to work."),"\n"),"\n",r.createElement(t.li,null,"\n",r.createElement(t.p,null,r.createElement(t.strong,null,"Offline installer")," bundles everything you need so we do not need to connect to the Internet while installing."),"\n"),"\n"),"\n",r.createElement(t.p,null,"Download the offline installer to the development workstation from the ",r.createElement(t.a,{href:"https://github.com/goharbor/harbor/releases"},"Harbor releases")," page and copy it to the Harbor host."),"\n",r.createElement(t.p,null,"Extract the installer."),"\n",r.createElement(t.pre,null,r.createElement(t.code,{className:"language-shell"},"tar xzvf harbor-offline-installer-v2.8.3.tgz \n")),"\n",r.createElement(t.p,null,"The installer will be extracted to ",r.createElement(t.code,null,"harbor")," directory in the current path.\nGo in and create ",r.createElement(t.code,null,"harbor.yml")," by making a copy of ",r.createElement(t.code,null,"harbor.yml.tmpl"),"."),"\n",r.createElement(t.pre,null,r.createElement(t.code,{className:"language-shell"},"cd harbor\ncp harbor.yml.tmpl harbor.yml\n")),"\n",r.createElement(t.p,null,"The ",r.createElement(t.code,null,"harbor.yml")," sets the initial parameters for the Harbor installation."),"\n",r.createElement(t.p,null,"Let's update the ",r.createElement(t.code,null,"certificate")," and ",r.createElement(t.code,null,"private_key")," parameters to set the path to the certificate and key files we created."),"\n",r.createElement(t.pre,null,r.createElement(t.code,{className:"language-yaml"},"# https related config\nhttps:\n  # https port for harbor, default is 443\n  port: 443\n  # The path of cert and key files for nginx\n  certificate: /etc/docker/certs.d/registry.cloudqubes.com/registry.cloudqubes.com.cert\n  private_key: /etc/docker/certs.d/registry.cloudqubes.com/registry.cloudqubes.com.key\n\n")),"\n",r.createElement(t.p,null,"Run the installation script."),"\n",r.createElement(t.pre,null,r.createElement(t.code,{className:"language-shell"},"sudo ./install.sh \n")),"\n",r.createElement(t.p,null,"Check the running containers."),"\n",r.createElement(t.pre,null,r.createElement(t.code,{className:"language-shell"},"sudo docker container ls\n")),"\n",r.createElement(t.p,null,"Make sure all containers are up and running."),"\n",r.createElement(t.pre,null,r.createElement(t.code,{className:"language-shell"},'CONTAINER ID   IMAGE                                COMMAND                  CREATED      STATUS                             PORTS                                                                            NAMES\n1f54cb0ae6d2   goharbor/nginx-photon:v2.8.3         "nginx -g \'daemon of…"   4 days ago   Up 10 seconds (health: starting)   0.0.0.0:80->8080/tcp, :::80->8080/tcp, 0.0.0.0:443->8443/tcp, :::443->8443/tcp   nginx\nfa40611eb108   goharbor/harbor-jobservice:v2.8.3    "/harbor/entrypoint.…"   4 days ago   Restarting (2) 48 seconds ago                                                                                       harbor-jobservice\nf7bd16f4d374   goharbor/harbor-core:v2.8.3          "/harbor/entrypoint.…"   4 days ago   Up 33 seconds (healthy)                                                                                             harbor-core\nbc44f1a8f744   goharbor/harbor-registryctl:v2.8.3   "/home/harbor/start.…"   4 days ago   Up 10 seconds (health: starting)                                                                                    registryctl\n7657237ed9e7   goharbor/harbor-db:v2.8.3            "/docker-entrypoint.…"   4 days ago   Up 10 seconds (health: starting)                                                                                    harbor-db\nf2e8f5b6a88f   goharbor/harbor-portal:v2.8.3        "nginx -g \'daemon of…"   4 days ago   Up 11 minutes (healthy)                                                                                             harbor-portal\n3ce34722713b   goharbor/registry-photon:v2.8.3      "/home/harbor/entryp…"   4 days ago   Up 10 seconds (health: starting)                                                                                    registry\nd0980474a980   goharbor/redis-photon:v2.8.3         "redis-server /etc/r…"   4 days ago   Up 11 minutes (healthy)                                                                                             redis\n303bd115d130   goharbor/harbor-log:v2.8.3           "/bin/sh -c /usr/loc…"   4 days ago   Up 11 minutes (healthy)            127.0.0.1:1514->10514/tcp                                                        harbor-log\nubuntu@k8s1:~/harbor$ history\n')),"\n",r.createElement(t.p,null,"If you happen to restart Docker Service for some reason, all the containers belonging to Harbor may not start. In such situations go to the installation directory and use ",r.createElement(t.code,null,"docker-compose")," to start the containers again."),"\n",r.createElement(t.pre,null,r.createElement(t.code,{className:"language-shell"},"sudo docker-compose up -d\n")),"\n",r.createElement(t.h2,null,"Login to Harbor web UI"),"\n",r.createElement(t.p,null,"Configure the ",r.createElement(t.code,null,"hosts")," file in the development workstation to resolve ",r.createElement(t.code,null,"registry.cloudqubes.com")," to the IP address of the Harbor host and go to ",r.createElement(t.code,null,"https://registry.cloudqubes.com")," to log in to the Harbor UI."),"\n",r.createElement(t.p,null,"Harbor creates an ",r.createElement(t.code,null,"admin")," account at the installation with the password set in the ",r.createElement(t.code,null,"harbor_admin_password")," directive in ",r.createElement(t.code,null,"harbor.yml"),". Login to Harbor UI with this password."),"\n",r.createElement(t.h1,null,"#4 Create a project in Harbor"),"\n",r.createElement(t.p,null,"On the Harbor web UI home page, click on ",r.createElement(t.code,null,"New Project"),"."),"\n",r.createElement(t.p,null,"Enter the name ",r.createElement(t.code,null,"number-crunch"),", tick the checkbox ",r.createElement(t.code,null,"Public"),", and click ",r.createElement(t.code,null,"OK")," to create the project."),"\n",r.createElement(t.p,null,r.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; "\n    >\n      <a\n    class="gatsby-resp-image-link"\n    href="/static/fa6fada09b38ddb8b232a5b0aed456f5/c3611/harbor-webui-projects.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n    <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 63%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAABYlAAAWJQFJUiTwAAACqklEQVR42p2Qz0/TYBjHe/AnMowpRPdD1q7t2q4d69qu29qu2wBdSHAad9LjjFG4GCMEzCqRABqDCWg8edCTclDvHvwfPHj14MGTMYQt4cJCH58WGOGIh0+e532f9/0+3+ch7lXnZ6ZGVxa+f/3R2vq15f79+cddbL51p2sv3AeTqwGPbqy5szcPeVhfc5ulFbdpLbl37OXWXef5QrO0NHM7PX+BuNVYbzfq6zA1/d578+4b+Dx+ugGzrQ8w536EuScbsLD8+ZBnX6C1+Aka11/Btdoq1Cdeeo36a5icWO3o5n2eiJcnN8n8Fe+EYO6cSZvdU1mje9Yods/lzW4f0osFq9tfsIO8D+vnrRLidEOmvdNv2t6gXdkkeZ0nZLvWlqyrwOVGPVrVga2kIeFIQNliQNwWgHFkEMc1EMfUIKedFCJhTcSz5FGOCFJZ61T1Kk/Q6VybVQpwiZO9mKiBoFWAkosQ5jSIJPUeYn4cWKzF0ybIZg0EYzzIRZyON8aAzlgdXkeHMT7TZjN5iKBgmFcgLGYhklIhmtIQdR8NGN0CWjUhnikAo1lAZYswnDaAzhY9znAgKmkdkuJ9wZE9h4zkRUUVKM2BuGJBTDYgJung30UFbILN/BiAdzFschlhUXBYzuFZ3ROMoiCDDsOs7PkP+OIYJLQSJLImJI0yUEoRhEI1iFzOCSKj2cDpTuA2VRz1kkYFRN3uRA4EfYfDYjYQ9MWorA0J/EijKIWfuFzJHw0Y1Qoihe/jaMKvC/kK7rAMnFrsOdxiM4HgblRQPBzpKNgosh+Poh7E3RiuICIo7d4OY4ISjOzvx9/NMfH2d703Mi1pvylJ275Ii+0wO9KJJJXjwSttZDucVH4PJkSOOD0wwJBkWAiFSD5E/h/9JCkMDA0xBEGc/Af7vn0+3CBYvgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="Harbor Web UI - Project list"\n        title=""\n        src="/static/fa6fada09b38ddb8b232a5b0aed456f5/c1b63/harbor-webui-projects.png"\n        srcset="/static/fa6fada09b38ddb8b232a5b0aed456f5/5a46d/harbor-webui-projects.png 300w,\n/static/fa6fada09b38ddb8b232a5b0aed456f5/0a47e/harbor-webui-projects.png 600w,\n/static/fa6fada09b38ddb8b232a5b0aed456f5/c1b63/harbor-webui-projects.png 1200w,\n/static/fa6fada09b38ddb8b232a5b0aed456f5/d61c2/harbor-webui-projects.png 1800w,\n/static/fa6fada09b38ddb8b232a5b0aed456f5/97a96/harbor-webui-projects.png 2400w,\n/static/fa6fada09b38ddb8b232a5b0aed456f5/c3611/harbor-webui-projects.png 2992w"\n        sizes="(max-width: 1200px) 100vw, 1200px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n  </a>\n    </span>'}}),"\n",r.createElement(t.em,null,"Harbor Web UI - Project list")),"\n",r.createElement(t.p,null,"Click on the project name ",r.createElement(t.code,null,"number-crunch")," to access the project details."),"\n",r.createElement(t.p,null,r.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; "\n    >\n      <a\n    class="gatsby-resp-image-link"\n    href="/static/f5bd34043ed9021c5cf2ce29c131a0a3/c3611/harbor-web-ui-counter-app-repos.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n    <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 63%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAABYlAAAWJQFJUiTwAAACk0lEQVR42p2SzU/TYBjAmxiCX8xoRWXraNdudKXt1q3dB/3YGAaJgAQDFz0ZjFG4GCNRDHVEEIliAhoOntSDcjD8ASb8ER68evDAyRjClnBhoY/PW8YEb3j45X36Pk9/ed73eam7xanJ8Z758rev36e3fm66v3/8cp/deudO9L507/cv+jwcXjrEg6Eld8yad8e65tzb5vPpO/ZCecyam7ypTp2lbowsV0aGlmF84r238mEdVj6uw5PZVXj09BM8Lq/C1MxnKL9YazCzsAbu7BcYvf4Grl1dhKGB197o8FsY7H9VNYx7IsV2D27SuV7vmGTuNMtWrUm2a8dVJGnXTiSdOvZhEnYtoHfXzuil2imtsHNSK3jnjNImLRoipdh9Fdnqg1i25AmpLohnCyCmTehI54FPZIBTdJ9wXIOwtIdoWFjnQETNgJzv9sg/SsaumqYpUlwiUxG0PFyMKV5YNkBAmWDYIOgWcLhPYJM5YBQDGNWAsJKBqOGAbF32c6pzxZOdXohmnCqnYochKYnCHFxCISOlIJJESdqC9kQW2rGDfTiU7q8sdu7nsbY9kfNYjNviWpXmRBTGE5VoCjuMyh7TmYaobgIj6xDCOIxdEQGJyR6J/ZyURmkOuyoSqYdSsv9XyCfrHWKxoDvAp23EAl7Ho+PxIikTxHwJtJ4BP27kEPz2SD2bzO8Jg/UOw50pX8jhHXI4nIOQOxVzRejIFnF4BYgcqMHY4zHParmGcIsMBYW7QSnl4fGOBKtmdskdMnK60ugwhE+BTBmF/h39S6gOc2Bt5IgY12BnqhokQnxjG6yib1/gpUpbLFEN4rSOSAXZxilvnOelGNUcCAg03RZvaaHFFvr/OE3T8UBrq0BRVNMf/M19RHGbMw0AAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="number-crunch repositories"\n        title=""\n        src="/static/f5bd34043ed9021c5cf2ce29c131a0a3/c1b63/harbor-web-ui-counter-app-repos.png"\n        srcset="/static/f5bd34043ed9021c5cf2ce29c131a0a3/5a46d/harbor-web-ui-counter-app-repos.png 300w,\n/static/f5bd34043ed9021c5cf2ce29c131a0a3/0a47e/harbor-web-ui-counter-app-repos.png 600w,\n/static/f5bd34043ed9021c5cf2ce29c131a0a3/c1b63/harbor-web-ui-counter-app-repos.png 1200w,\n/static/f5bd34043ed9021c5cf2ce29c131a0a3/d61c2/harbor-web-ui-counter-app-repos.png 1800w,\n/static/f5bd34043ed9021c5cf2ce29c131a0a3/97a96/harbor-web-ui-counter-app-repos.png 2400w,\n/static/f5bd34043ed9021c5cf2ce29c131a0a3/c3611/harbor-web-ui-counter-app-repos.png 2992w"\n        sizes="(max-width: 1200px) 100vw, 1200px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n  </a>\n    </span>'}}),"\n",r.createElement(t.em,null,"number-crunch repositories")),"\n",r.createElement(t.p,null,"There are no repositories, as we have not yet published any container images to this project."),"\n",r.createElement(t.h1,null,"#5 Push images to Harbor"),"\n",r.createElement(t.p,null,"In the developer workstation, clone the repository ",r.createElement(t.a,{href:"https://github.com/cloudqubes/number-crunch"},"number-crunch")," and build container images."),"\n",r.createElement(t.pre,null,r.createElement(t.code,{className:"language-shell"},"git clone git@github.com:cloudqubes/number-crunch.git\ndocker build -t registry.cloudqubes.com/number-crunch/number-crunch-app:1.0.0 .\n")),"\n",r.createElement(t.p,null,"Our image name is starting with ",r.createElement(t.code,null,"registry.cloudqubes.com"),". This is the FQDN of the Harbor host. This name is required for Kubernetes to locate the container registry."),"\n",r.createElement(t.p,null,"Login to Harbor container registry from Docker CLI in the developer workstation."),"\n",r.createElement(t.pre,null,r.createElement(t.code,{className:"language-shell"},"sudo docker login -u admin registry.cloudqubes.com\n")),"\n",r.createElement(t.p,null,"When prompted, type in the password of the Harbor ",r.createElement(t.code,null,"admin")," user. Since we have not changed it, the password is the same as we used to login to the Harbor UI."),"\n",r.createElement(t.p,null,"Push the image to Harbor."),"\n",r.createElement(t.pre,null,r.createElement(t.code,{className:"language-shell"},"sudo docker push registry.cloudqubes.com/number-crunch/number-crunch-app:1.0.0\n")),"\n",r.createElement(t.h1,null,"#6 Create Kubernetes Deployment"),"\n",r.createElement(t.p,null,"Create a Kubernetes secret to store Harbor login information."),"\n",r.createElement(t.pre,null,r.createElement(t.code,{className:"language-shell"},'kubectl create secret docker-registry harbor-registry-secret --docker-server="https://registry.cloudqubes.com" --docker-username="admin" --docker-password="Harbor12345"\n')),"\n",r.createElement(t.p,null,"Create the manifest ",r.createElement(t.code,null,"number-crunch.yml"),"."),"\n",r.createElement(t.pre,null,r.createElement(t.code,{className:"language-yaml"},"apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: number-crunch-app\nspec:\n  selector:\n    matchLabels:\n      app: number-crunch\n  replicas: 2 \n  template:\n    metadata:\n      labels:\n        app: number-crunch\n    spec:\n      containers:\n      - name: number-crunch\n        image: registry.cloudqubes.com/number-crunch/number-crunch-app:1.0.0\n        imagePullPolicy: Always\n        ports:\n        - containerPort: 8080\n      imagePullSecrets:\n      - name: harbor-registry\n\n")),"\n",r.createElement(t.p,null,"Note the image name starting with ",r.createElement(t.code,null,"registry.cloudqubes.com")," which is the FQDN of our container registry."),"\n",r.createElement(t.p,null,"Use ",r.createElement(t.code,null,"kubectl")," to create the Deployment."),"\n",r.createElement(t.pre,null,r.createElement(t.code,{className:"language-shell"},"kubectl apply -f number-crunch.yml\n")),"\n",r.createElement(t.p,null,"Check whether all Pods are running."),"\n",r.createElement(t.pre,null,r.createElement(t.code,{className:"language-shell"},"kubectl get pods\n")),"\n",r.createElement(t.pre,null,r.createElement(t.code,{className:"language-shell"},"NAME                                READY   STATUS    RESTARTS       AGE\nnumber-crunch-app-5dc7b48bb-4pw7r   1/1     Running   0              118m\nnumber-crunch-app-5dc7b48bb-85xql   1/1     Running   0              118m\n")),"\n",r.createElement(t.p,null,"If any node cannot pull images from Harbor, the Pods scheduled on that node will fail to start. You can use ",r.createElement(t.code,null,"kubectl describe pod")," to check the reason for failure."),"\n",r.createElement(t.pre,null,r.createElement(t.code,{className:"language-shell"},"kubectl describe pod <pod-name>\n")),"\n",r.createElement(t.p,null,"If any Pod fails to start, one of these are likely to be the reason."),"\n",r.createElement(t.ul,null,"\n",r.createElement(t.li,null,"\n",r.createElement(t.p,null,"No IP network connectivity from the node to Harbor host."),"\n"),"\n",r.createElement(t.li,null,"\n",r.createElement(t.p,null,"The node fails to resolve the Harbor DNS name to IP address."),"\n"),"\n",r.createElement(t.li,null,"\n",r.createElement(t.p,null,"A firewall is blocking HTTPS port from the node to Harbor host."),"\n"),"\n",r.createElement(t.li,null,"\n",r.createElement(t.p,null,"SSL certificates are not properly configured either on Harbor host or the node."),"\n"),"\n"),"\n",r.createElement(t.p,null,"Troubleshooting along these points will lead you to a solution."),"\n",r.createElement(t.p,null,"Harbor shows you the number of pulls for each image. This is also useful to ascertain whether Kubernetes can successfully pull images from this registry."),"\n",r.createElement(t.p,null,r.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; "\n    >\n      <a\n    class="gatsby-resp-image-link"\n    href="/static/30adc3e62b5962b09c4a802153f50c04/c3611/harbor-image-pulls.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n    <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 63%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAABYlAAAWJQFJUiTwAAACiklEQVR42p2Sz08TURDHNzEEDbaGrCi023bbbdndbru/ulv6YwulSkhQCBEvejIYo+DBGIliWGuQgAGiEvXgSU6YmGC8avwrjFcOHjgYD4Q24ULDG+dtEUlMTPDwybzMzPu+78wuc7NvemqiMl/9+unbzPb3Lffnxg939tobd3Jg0b0ztOzeHXnm3ht98ReT5xbd8fyce91ZmLnR+7Q6XpybupqebmeujK3UxkZWYGJylbxe/QKvVj/Dw9l3cP/RGjyorsHMk/fweOEDVBfWm8yvw9zSR5i4/RYuDC7D6PBzcvnSSxgeWqoXrFsiEylf3GJ7BsgxubDbqhQbLYrTaE07jeOq0zihlRB6Lnrx95lyyqo0/Ga50aaXdtv0XtJu92/5REtkUs5gTSkOQtzuJ4KRBzFbAtHMQ7eZA0G1gU9lPEKSDpykgaDnQMmVIapmQbIdUIsVEjcLkLRL9bRVEBletWu06WwiRUIpCwQsCpYDQqYIPOZ5LQcRrQe4lA2cYkEU64pz3otyvh/MyhBJOgO0vx4Q0yITlDUU7IFOFORkA6J4mTeKEEYH4bSNNCOPeRojmKcP00dCKiVLaK5T0uosL6KgpNbiBjqMK4RLmhBHdyG8yOElSlDJeGJUJIh1+gCHOVpLZMsQyzgkjMIxLftHMKbtO0xmsKEEUau3idkcO4q75fX8oXPOo9vGfWf7SAzHlyynKRjYdxhWDBLAkamLYNI4hPlP0K23+6BsHAhu048SShp7KEiw6YgYe0GcDO/WDhwGZd37ytSht5+jQbjmfpsO8R/bjKQyO2dicq0rodYDkn5UashOl6Rvno7JCabV7xdYtkvy+VjRx/4fJ1lW8nd0CAzDtPwClWh8KASqQ/gAAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="Number of pulls for a repository in Harbor project"\n        title=""\n        src="/static/30adc3e62b5962b09c4a802153f50c04/c1b63/harbor-image-pulls.png"\n        srcset="/static/30adc3e62b5962b09c4a802153f50c04/5a46d/harbor-image-pulls.png 300w,\n/static/30adc3e62b5962b09c4a802153f50c04/0a47e/harbor-image-pulls.png 600w,\n/static/30adc3e62b5962b09c4a802153f50c04/c1b63/harbor-image-pulls.png 1200w,\n/static/30adc3e62b5962b09c4a802153f50c04/d61c2/harbor-image-pulls.png 1800w,\n/static/30adc3e62b5962b09c4a802153f50c04/97a96/harbor-image-pulls.png 2400w,\n/static/30adc3e62b5962b09c4a802153f50c04/c3611/harbor-image-pulls.png 2992w"\n        sizes="(max-width: 1200px) 100vw, 1200px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n  </a>\n    </span>'}}),"\n",r.createElement(t.em,null,"Number of Pulls")),"\n",r.createElement(t.h2,null,"Wrapping up"),"\n",r.createElement(t.p,null,"If you have ",r.createElement(t.a,{href:"#why-use-a-private-container-registry"},"a good reason")," for a private container registry, ",r.createElement(t.a,{href:"https://goharbor.io/"},"Harbor")," is definitely for you."),"\n",r.createElement(t.p,null,"It's a ",r.createElement(t.a,{href:"https://www.cncf.io/projects/harbor/"},"CNCF graduated"),", open-source project. It's easy to get started and includes all the features for a ",r.createElement(t.a,{href:"https://goharbor.io/docs/2.8.0/administration/"},"secure private registry"),"."),"\n",r.createElement(t.p,null,"So, give it a try in your VPC or data center."),"\n",r.createElement(t.p,null,"And let me know if something goes wrong while you are setting up Harbor."),"\n",r.createElement(t.p,null,"Post your problem in comments here or reach me via Twitter ",r.createElement(t.a,{href:"https://twitter.com/cloudqubes"},"@cloudqubes")," for any help."))}var o=function(e){void 0===e&&(e={});const{wrapper:t}=Object.assign({},(0,a.ah)(),e.components);return t?r.createElement(t,e,r.createElement(l,e)):l(e)},c=n(72),s=n(5595),i=n(8370);const u=e=>{let{data:t,children:n}=e;return r.createElement(c.Z,{pageTitle:t.mdx.frontmatter.title},r.createElement("div",{className:i.HV},r.createElement("article",{className:i.nC},r.createElement("div",null,r.createElement("span",{className:i.F4},t.mdx.frontmatter.date," - "),r.createElement("span",{className:i.F4},t.mdx.fields.timeToRead.text)),r.createElement("h1",{className:i.TN},t.mdx.frontmatter.title),n)))},m=e=>{let{data:t}=e;return r.createElement(s.p,{title:t.mdx.frontmatter.title,description:t.mdx.frontmatter.description})};function d(e){return r.createElement(u,e,r.createElement(o,e))}},5595:function(e,t,n){n.d(t,{p:function(){return l}});var a=n(7294),r=n(1883);const l=e=>{let{title:t,description:n,pathname:l,children:o}=e;const{title:c,description:s,image:i,siteUrl:u,twitterUsername:m}=(0,r.useStaticQuery)("1865044719").site.siteMetadata,d={title:t||c,description:n||s,image:""+u+i,url:""+u+(l||""),twitterUsername:m};return a.createElement(a.Fragment,null,a.createElement("title",null,d.title),a.createElement("meta",{name:"description",content:d.description}),a.createElement("meta",{name:"image",content:d.image}),a.createElement("meta",{name:"twitter:card",content:"summary_large_image"}),a.createElement("meta",{name:"twitter:title",content:d.title}),a.createElement("meta",{name:"twitter:url",content:d.url}),a.createElement("meta",{name:"twitter:description",content:d.description}),a.createElement("meta",{name:"twitter:image",content:d.image}),a.createElement("meta",{name:"twitter:creator",content:d.twitterUsername}),a.createElement("link",{rel:"icon",href:"data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>👤</text></svg>"}),o)}},8370:function(e,t,n){n.d(t,{F4:function(){return l},HV:function(){return r},TN:function(){return o},nC:function(){return a}});var a="article-module--container--2d8cc",r="article-module--outerContainer--119e3",l="article-module--post-meta--34964",o="article-module--title--f5d32"},1151:function(e,t,n){n.d(t,{ah:function(){return l}});var a=n(7294);const r=a.createContext({});function l(e){const t=a.useContext(r);return a.useMemo((()=>"function"==typeof e?e(t):{...t,...e}),[t,e])}}}]);
//# sourceMappingURL=component---src-pages-blog-mdx-frontmatter-slug-js-content-file-path-blog-private-container-registry-with-harbor-index-mdx-49f67c5889dd97fa1b2b.js.map